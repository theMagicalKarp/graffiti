var defaultImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAyAAAAHCCAYAAAAXY63IAAAcQ0lEQVR4Xu3XsQkAIBAEwbf/otXAFtxoBOOD4ZNdM7Pv9wgQIECAAAECBAgQIPBdYAmQ78YGCBAgQIAAAQIECBB4AgLEKRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQICxA0QIECAAAECBAgQIJAJCJCM2hABAgQIECBAgAABAgLEDRAgQIAAAQIECBAgkAkIkIzaEAECBAgQIECAAAECAsQNECBAgAABAgQIECCQCQiQjNoQAQIECBAgQIAAAQIHWGfCEMad58QAAAAASUVORK5CYII=';


var HOST = '127.0.0.1';
var PORT = 3000; 
var redis_channel = 'paint'
var redis_image_key = 'image';

var express = require('express');
var app = express();
app.use(express.urlencoded());
app.use(express.json()); 

var server = require('http').createServer(app);
var io = require('socket.io').listen(server);
var redis = require('redis');

server.listen(PORT, HOST);

app.get('/', function (req, res) {
  res.sendfile(__dirname + '/home.html');
});

var redis_pub = redis.createClient(6379, '127.0.0.1');
var redis_sub = redis.createClient(6379, '127.0.0.1');

app.get('/image', function (req, res) {
  res.setHeader('Content-Type', 'text/plain');
  redis_pub.get(redis_image_key, function(err, value) {
    if (value === null) {
      redis_pub.set(redis_image_key, defaultImage);
      value = defaultImage;
    }
    res.end(value);
  });
});

app.post('/image', function (req, res) {
  redis_pub.set(redis_image_key, req.body.dataURL);
  res.end('success');
});

redis_sub.subscribe(redis_channel);

redis_sub.on('message', function(channel, message) {
  if (channel !== redis_channel)
    return;
  io.sockets.emit('paint', message);
});


io.sockets.on('connection', function (socket) {
  socket.on('paint', function (data) {
    redis_pub.publish(redis_channel, data);
  });
});
